---
title: "Data Handle"
author: "James Woods"
date: "1/14/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Reading Data In

## Financial Data

This was downloaded from Oregon department of eduction.

```{r}
DistrictFinance <- read.csv("https://s3-us-west-2.amazonaws.com/woodsjeeschools/ActualExpendituresFundFunction30.CSV") 

library(stringr)
library(dplyr)

#Convert to starting of fiscal year.  Remember that the year may not match with the test scores.
DistrictFinance$YearBeginning <- as.factor(str_sub(as.character(DistrictFinance$SchlYr),-4) )

```


```{r}
summary(DistrictFinance)
```

## Test data read

```{r}
library(openxlsx)

# New combined files
Tests15 <- read.xlsx("https://www.oregon.gov/ode/educator-resources/assessment/TestResults2015/pagr_schools_tot_ela_math.xlsx")

Tests16  <- read.xlsx("https://www.oregon.gov/ode/educator-resources/assessment/TestResults2016/pagr_schools_tot_ela_math.xlsx")

#Older files by topic can't be opened by xlsx so saving in gdocs and reading via csv.  These were downloaded via https://www.oregon.gov/ode/educator-resources/assessment/Pages/Test-Results-0910-through-1314.aspx 

## Math

Math14 <- read.csv("https://docs.google.com/spreadsheets/d/1mKkhwPVO_J4p8RCBuKiJauYz8Kx7xdBx4Yq9xqlVjss/pub?gid=336032123&single=true&output=csv")

Math13 <- read.csv("https://docs.google.com/spreadsheets/d/107Lp_UBqcTnObunO1lIPhq0sBOrpfSryHdW1HYY6qm4/pub?gid=1450304332&single=true&output=csv")

Math12 <- read.csv("https://docs.google.com/spreadsheets/d/1imChJVXmq4iVeaeB2S8qCeM01GxVegOhwW6v4RBswTI/pub?gid=1330438594&single=true&output=csv")

Math11 <- read.csv("https://docs.google.com/spreadsheets/d/12Tqn4RORNI2w3KoiqnVpq_Trd3Zm1MM51I5YXDZFvfk/pub?gid=657209680&single=true&output=csv")

Math10 <- read.csv("https://docs.google.com/spreadsheets/d/1CXKQ_yzcvQfEcS9C3iBD3Hsvj4ZqJ6ISuFwgoghzEFI/pub?gid=2015290170&single=true&output=csv")

## Reading

Read14 <- read.csv("https://docs.google.com/spreadsheets/d/1yJrAFMCcrqB8C_hLRDr6pN1ZWU4KUPON1CMc3h3yeAM/pub?gid=1572187371&single=true&output=csv")
Read13 <- read.csv("https://docs.google.com/spreadsheets/d/1MBhoFCZg2nAV7cSQnK0QX4s8yF8Oeda-ceaqWpyA3DA/pub?gid=1052055153&single=true&output=csv")
Read12 <- read.csv("https://docs.google.com/spreadsheets/d/1msHh_WXdRAKTPeUP6OgvK9AzWlbSx5O7pMBntq83dSA/pub?gid=652537434&single=true&output=csv")
Read11 <- read.csv("https://docs.google.com/spreadsheets/d/1Oe_P_Pxi4eIWtEWZZNfftzGNCdqNSvckMSfMaxYDZA4/pub?gid=1449554276&single=true&output=csv")
Read10 <- read.csv("https://docs.google.com/spreadsheets/d/1DScEAY9FPLRv7QoQrIhjNYQdF6LY078ZvVUQmnB2jWA/pub?gid=541255152&single=true&output=csv")


## Science

Sci14 <- read.csv("https://docs.google.com/spreadsheets/d/1AhXN382JnOrDv3MMp6bBI640VpZTpf1uuI-gm-xep3M/pub?gid=747992313&single=true&output=csv")
Sci13 <- read.csv("https://docs.google.com/spreadsheets/d/1JeEBL4yMxqKbnTh43mi-L5HEyaXBO96iuzw9UNUi0dE/pub?gid=1005826807&single=true&output=csv")
Sci12 <- read.csv("https://docs.google.com/spreadsheets/d/1tBnFq7P9r65zGP9AFEvVBExUCrGJWh9FystJryk83TI/pub?gid=1064106863&single=true&output=csv")
Sci11 <- read.csv("https://docs.google.com/spreadsheets/d/1hAJjcuFxSbLyWZ_b5Xp-ciZcQT1muYTf180SYUFHMVc/pub?gid=225335635&single=true&output=csv")
Sci10 <- read.csv("https://docs.google.com/spreadsheets/d/1HZJxmJ-n0dEdkNLlNox8lhUEkWdBigoycdB4Gh-mAlg/pub?gid=46470343&single=true&output=csv")

## Writting

Write14 <- read.csv("https://docs.google.com/spreadsheets/d/1rXrvkCAAFrO8_N-6YznQwuId0NTMOlo9OrI5wX18jJw/pub?gid=1285166754&single=true&output=csv")
Write13 <- read.csv("https://docs.google.com/spreadsheets/d/1EXWDmHLyXVjenck1AiXxxDRpqFEJEMuwt_XBLzTGozo/pub?gid=881482941&single=true&output=csv")
Write12 <- read.csv("https://docs.google.com/spreadsheets/d/1F4DNMNUAcV4U80NIJcLXzNYvZII8n2VdhnynId8WLpE/pub?gid=1358804477&single=true&output=csv")

#only 4-7
Write11 <- read.csv("https://docs.google.com/spreadsheets/d/1wuENaBv747xUCj5NGT9CtIM79QqMHzxK3NAWyqWmiEo/pub?gid=799752116&single=true&output=csv")

#only 4-7
Write10 <- read.csv("https://docs.google.com/spreadsheets/d/167c1jshh1156x-vJUE7L-R0EJTstuIegssfMwKwUEXk/pub?gid=156237836&single=true&output=csv")


```


## Eligible schools

Not all schools are eligible.  They must be served by an IOU.  Original file has odd formating.  So, saved and accessed via gdrive.

```{r}
#Non readable because of formating to make pretty.
#read.xlsx("http://www.oregon.gov/energy/SCHOOLS/Sb1149/documents/schools_list.xls")

Eligible <- read.csv("https://docs.google.com/spreadsheets/d/1WXNu3cNY4DyZ7yWXT2MPd3bd61M0Vmo2ty62Uux1TZU/pub?gid=1048793783&single=true&output=csv")
```

## Installed measures

```{r}
EEMs <-read.csv("https://docs.google.com/spreadsheets/d/15X3x4KCEx2-_JYLjq3gXhqS33EKBscW_LLPO-MggDFk/pub?gid=1734037341&single=true&output=csv")
```

## District demographics

Load dataframes for School performance from 2002-2016. The name for each dataframe is "Schoolxx" where xx is the last 2 digits of the ending academic year from which the data is for. The formating and the information provided in these school report cards slightly changes after 2012.   

```{r}
Schools16 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/17/RCmediaSchoolsAggregate.csv")
Schools15 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/16/RCmediaSchoolsAggregate.csv")
Schools14 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/15/RCmediaSchoolsAggregate.csv")
Schools13 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/14/RCmediaSchoolsAggregate.csv")
Schools12 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/13/RCmediaSchoolsAggregate.csv")
Schools11 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/12/RCmediaSchoolsAggregate.csv")
Schools10 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/11/RCmediaSchoolsAggregate.csv")
Schools09 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/10/RCmediaSchoolsAggregate.csv")
Schools08 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/09/RCmediaSchools.csv")
Schools07 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/08/RCmediaSchools.csv")
Schools06 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/07/RCmediaSchools.csv")
Schools05 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/06/RCmediaSchools.csv")
Schools04 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/05/RCmediaSchools.csv")
Schools03 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/04/RCmedia.csv")


# Link the data and see what we need


# Add year identifier for each
Schools03$Year <- 2003
Schools04$Year <- 2004
Schools05$Year <- 2005
Schools06$Year <- 2006
Schools07$Year <- 2007
Schools08$Year <- 2008
Schools09$Year <- 2009
Schools10$Year <- 2010
Schools11$Year <- 2011
Schools12$Year <- 2012
Schools13$Year <- 2013
Schools14$Year <- 2014
Schools15$Year <- 2015
Schools16$Year <- 2016

# make the school identifiers uniform witth 16 name
# 
library(dplyr)

Schools03 %>%
  rename( School.ID = instid) -> Schools03

Schools04 %>%
  rename( School.ID = instid) -> Schools04

Schools05 %>%
  rename( School.ID = InstID) -> Schools05
Schools06 %>%
  rename( School.ID = InstID) -> Schools06
Schools07 %>%
  rename( School.ID = InstID) -> Schools07
Schools08 %>%
  rename( School.ID = InstID) -> Schools08
Schools09 %>%
  rename( School.ID = InstID) -> Schools09
Schools10 %>%
  rename( School.ID = InstID) -> Schools10
Schools11 %>%
  rename( School.ID = InstID) -> Schools11
Schools12 %>%
  rename( School.ID = InstID) -> Schools12

Schools13 %>%
  rename( School.ID = School.ID) -> Schools13
Schools14 %>%
  rename( School.ID = School.ID) -> Schools14
Schools15 %>%
  rename( School.ID = School.ID) -> Schools15
Schools16 %>%
  rename( School.ID = School.ID) -> Schools16


#Make student count uniform with 16 names

CheckName <- function(db) {is.element("Total.Enrollment",names(db))}

# CheckName(Schools03)
Schools03 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools03

#CheckName(Schools04)
Schools04 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools04

#CheckName(Schools05)
Schools05 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools05

#CheckName(Schools06)
Schools06 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools06

#CheckName(Schools07)
Schools07 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools07

#CheckName(Schools08)
Schools08 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools08

#CheckName(Schools09)
Schools09 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools09

#CheckName(Schools10)
Schools10 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools10

#CheckName(Schools11)
Schools11 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools11

#CheckName(Schools12)
Schools12 %>%
  rename( Total.Enrollment = DailyMmbrshpAvgAmt1) -> Schools12

#CheckName(Schools13)
#CheckName(Schools14)
#CheckName(Schools15)
#CheckName(Schools16)

#Make the name checks faster
AllYearly <- list(Schools03,Schools04, Schools05, Schools06, Schools07, Schools08, Schools09, Schools10, Schools11, Schools12, Schools13, Schools14, Schools15, Schools16)

CheckName <- function(RName,db) {is.element(RName,names(db))}

#lapply(AllYearly, FUN = function(x)CheckName("Total.Enrollment",x))


# Pct.Ever.English.Learners
lapply(AllYearly, FUN = function(x)CheckName("Pct.Ever.English.Learners",x))
#fix 3-10

Schools03 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools03
Schools04 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools04
Schools05 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools05
Schools06 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools06
Schools07 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools07
Schools08 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools08
Schools09 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools09
Schools10 %>%
  rename( Pct.Ever.English.Learners = ESLStudPct) -> Schools10

# Pct.Economically.Disadvantaged
lapply(AllYearly, FUN = function(x)CheckName("Pct.Economically.Disadvantaged",x))
#fix 3-10


```

# Linking Data

Lets get the specific data items we need for each district.  Please note that this is district level data so we need to get expenditures for all grade levels as well as construction expenditures.


```{r}
summary(DistrictFinance$FuncDesc)

```


The key fund descriptions are:


+ Plant Capital
    + Building Acquisition; Construction; and Improvement Services 
    + Facilities Acquisition and Construction 
    + Site Acquisition and Development Services

+ Operation and Maintenance of Plant Services 

+ Education Expenditures
    + English Second Language Programs 
    + High School Programs 
    + Intermediate Programs
    + Middle/Junior High Programs
    + Primary (K-3) 

Will go with the major category of instruction for Educational expenditures.

```{r}
DistrictFinance %>% 
  filter( FuncDesc == 'Building Acquisition; Construction; and Improvement Services' | FuncDesc == 'Facilities Acquisition and Construction' | FuncDesc == 'Site Acquisition and Development Services') %>% 
  mutate(ExpType = 'Capital') -> CapitalExpenditures

DistrictFinance %>% 
  filter( FuncDesc == 'Operation and Maintenance of Plant Services' ) %>%
  mutate( ExpType = 'Operations' ) -> PlantOperations

# Going for the larger Instructional Category
# 
# DistrictFinance %>% filter(FuncDesc == 'English Second Language Programs' | FuncDesc == 'High School Programs' |  FuncDesc == 'Intermediate Programs' |FuncDesc == 'Middle/Junior High Programs' | FuncDesc == 'Primary (K-3)') %>% mutate(ExpType = 'Education') -> EducationExpenditures

DistrictFinance %>% 
  filter( MajFuncDesc == 'Instruction' ) %>% 
  mutate( ExpType = 'Education' ) -> EducationExpenditures

KeyBudget <- bind_rows(list(CapitalExpenditures, PlantOperations, EducationExpenditures))


```


Turn this into a one row per district per year data frame

```{r}
library(tidyr)
KeyBudget %>% spread(FuncDesc, Amount) -> Budget

```


## Installed Measures

Lets find a range of dates that we need to work with.

```{r}
EEMs %>% summary()
```

Lets focus in on the years.

```{r}
table(EEMs$ImplementedYear)

```


There were a bunch in 2010.  If I go back to 2006 I should be ok to establish parallel movement.

Lets get a list of school districts

```{r}
EEMs %>% select(SchoolDistrictName) %>% unique()
```


We have a list of eligible and ineligible by district.

```{r}
Eligible %>% 
  select(District.ID, District.Name, SB.1149.Eligibility) %>% 
  unique()


```

Lets find these complex districts.

```{r}
Eligible %>% 
  select(District.ID, District.Name, SB.1149.Eligibility) %>% 
  unique() %>%
  group_by(District.ID, District.Name) %>%
  count() %>%
  filter(n > 1)

```




Note that some districts have schools that are both eligibile and not.  That could be a good comparision.  If there are similar schools in the same district one with and one without EEMs then we have a good comparison.
 
Lets check for installations against this list.  Because the EEM data file has a school code and not a district code, I need to merge that in.

```{r}
Eligible %>% 
  select( District.ID, District.Name, SB.1149.Eligibility ) %>% 
  unique() %>%
  group_by( District.ID, District.Name ) %>%
  count() %>%
  filter(n > 1) -> BorderDistrict

inner_join(Eligible, BorderDistrict) -> BorderSchools

inner_join(BorderSchools, EEMs, by = c("School.ID" = "FacilityODEId")) -> BorderEEM

BorderEEM
```

We have schools in that list with EEMs.

Lets get the schools with EEMs.

```{r}
BorderEEM %>%
  select(School.ID, School.Name, District.ID, District.Name, FacilityTypeDescription) %>%
  unique() -> SchoolsWEEM

SchoolsWEEM

```


We need to purge the charter and special schools.  Charter schools have charter in the name so it is easy

```{r}
library(dplyr)
library(stringr)

str_detect(SchoolsWEEM$School.Name, "Charter") %>% table()

SchoolsWEEM %>% 
  mutate(Charter = str_detect(School.Name, "Charter")) %>%
  filter(Charter == FALSE) ->SchoolsWEEM


```


Now, lets see if we have schools of the same type, elementary, middle etc, within the same district that are not eligible.

```{r}
#Need to add the type of institution to the Eligible data frame
#
#


library(stringr)

Schools16 %>% 
  select(School.ID, School.Type) -> SchoolType

Eligible %>% 
  left_join(SchoolType, by = c("School.ID" = "School.ID")) -> Eligible

SchoolsWEEM %>%
  left_join(SchoolType, by = c("School.ID" = "School.ID")) -> SchoolsWEEM
  
Eligible %>% 
  filter(SB.1149.Eligibility == "NO") %>%
  right_join(SchoolsWEEM, c("District.ID"= "District.ID", "School.Type" = "School.Type")) %>%
  filter(!is.na(ESD) ) -> SameTypeBorder

SameTypeBorder


```





## District Demographics

The files are so different from year to year.  This is going to be fun.  This would be so much easier if the ODE people understood some statistics.



