---
title: "The Effect of Energy Efficiency Measures on K12 Educational Performance"
output: beamer_presentation
bibliography: ../Bibliography.bib
citation_package: natbib
biblio-style: "apalike"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Abstract


This is early work.  Still much to do.

# Background

+ Cost effectiveness evaluation requires an evaluation of _all_ costs and _all_ benefits.
+ Not all jurisdictions use "participant benefits" in evaluation of cost effectiveness because they are not enjoyed by the rate payer.  
+ The "National Efficiency Screening Project" only gives guidance on including non-energy benefits as it explains the symmetry principal, "If you include participant benefits, include participant costs".
+ Some jurisdictions, e.g., The Energy Trust of Oregon, are reducing the technical complexity of evaluations to _reduce evaluation costs_

# "Reduced Technical Complexity"

+ Free ridership/drivership by survey, "Would you have done this without ETO incentives?"
    + Assume people tell the truth.
    + Economists don't believe that.
+ Simpler econometrics
    + No accounting for self-selection bias.
    + No accounting for sampling bias.
    + Stops  'futzing'
    
In short, the opposite of what economics is doing with program evaluation, but more inline with engineering approach.

# Why the Effect of Energy Efficency on Education is Interesting

+ Decisions to improve structures is a financial decision -- money saved on energy.
+ No financial gain, not allowed to participate.

Improvements in student/staff health and the lifetime effects of academic performance dwarf the value of energy savings.

# Daylighting (Sampling)

+ D. A. Kleiber and others. “Environmental Illumination and Human
Behavior: The Effects of Spectrum of Light Source on Human Performance in a
University Setting.” (1973)
    + 3 schools  
    + Movement to portables.
    + 17% drop

+ L. Heschong. “Daylighting in Schools: An Investigation into the
Relationship between Daylighting and Human Performance. Detailed Report.”
(1999).
    + "Data indicate students with the most classroom daylighting progressed 20 percent faster on math tests and 26 percent on reading tests in one year than those with the least."
    + No control for self-selection
    + ~20,000 schools

# 

+ L. Heschong, R. L. Wright and S. Okura. “Daylighting impacts on human
performance in school”. In: _Journal of the Illuminating Engineering
Society_ 31.2 (2002), pp. 101-114.
    + Positive effect. Scale is dubious.
    + Multiple school districts with various quality of daylighting.
    

+ M. H. Nicklas and G. B. Bailey. “Analysis of the Performance of
Students in Daylit Schools.” (1996).
    + "... [daylit] schools outperformed students attending artificially lighted
schools by 5 to 14 percent."

# Indoor Air Quality (Sampling)

+ M. J. Mendell and G. A. Heath. “Do indoor pollutants and thermal
conditions in schools influence student performance? A critical review of
the literature”. In: _Indoor air_ 15.1 (2005), pp. 27-52.
    + Not all that critical( Three studies of students, x2 from 70s)
    + Summary, something is there but we don't know what it is.

+ S. Moonie, D. A. Sterling, L. W. Figgs, et al. “The relationship
between school absence, academic performance, and asthma status”. In:
_Journal of School Health_ 78.3 (2008), pp. 140-148.
    + 3K students
    + More absences, lower test scores.
    + Asthma kids have more absences but not lower scores with same absences.

#

+ U. Haverinen-Shaughnessy, D. Moschandreas and R. Shaughnessy.
“Association between substandard classroom ventilation rates and students’
academic achievement”. In: _Indoor air_ 21.2 (2011), pp. 121-131.
    + Schools with less than 7.1 l/s/person, i.e., less than ASHRAE Standard 62 in 2004.
    + "...[1 l/s per person] increase in the ventilation rate within that range, the proportion of students passing standardized test (i.e., scoring satisfactory or above) is expected to increase by 2.9% (95%CI 0.9–4.8%) for math and 2.7% (0.5–4.9%) for reading."

# In Short

+ Students got stuck in the 60s-70s air conditioning daylighting vs air conditioning battle.
+ Air quality is important but we don't know exactly what part
    + Keep in mind that allergenic mold concentrations, colony forming bodies, can change by factor of 10 in a few hours.
    + Hard to measure.
      
# Why Oregon Schools?

+ Nice features that remove many, but not all, self-selection problems.
+ Decison making cutoffs are based on energy savings, not educational outcomes.

+ Still problems
    + Data shortcoming ... as we go along.
    + Standardized tests are not standard from year-to-year.
    + Building data is not so important to departments of education.

Now, on to the data ...

# SB 1149

+ [SB 1149 (1999)](https://www.oregonlegislature.gov/bills_laws/lawsstatutes/1999orLaw0865.html) was Oregon's deregulation bill.
    + It was part of the implementation of FERC 888.
    + Established a public purpose charge that funds thing like The Energy Trust of Oregon.
+ The 3% Public Purpose Charge was collected by _almost_ all the IOUs.
    + Pacificorp and PGE collect, but Idaho Power in Eastern Oregon does not.
    + Used for Energy Efficiency
    + 10% must be used in schools.
    
# Schools Program    

Schools using SB 1149 public purpose funds:

+ Complete energy audits of _buildings_, not districts, served by Pacificorp or PGE (with limitations);
+ Audits must be completed by an approved audit company;
+ Implement the approved Energy Efficiency Measures identified in the audits;
+ Report Energy Use Index data in the Schools Interactive Database each year; 


# Key Points

+ Not all districts are eligible.
+ Not all schools within districts are eligible.


Makes it easier to establish a natural control group for any treated school by using others in the district.

# Educational Funding in Oregon

Oregon Educational Funding has key provisions that makes using schools in other district more attractive than other states.

+ 1991 Oregon establishes an Equalization Formula:
    + The legislature establishes a biennial K12 State School Fund Budget
    + The State School Fund budget is distributed equally by student across the state, but adjusted for property tax collections.
    + $1 increase in property tax collected results in $1 less in State School Fund support.
    + Measure 5 and 50 property tax limitations put most of the power with the legislature.
    
+ Result, equal, per-student funding across the state with a few exceptions:
    + Short-term, 3 year, property tax operating levies.
    + Capital bonds
    + A few, depends on year, school districts with few students but lots of taxable property.

Much smaller inter-district funding differences than other states.

# School District Size

+ Oregon has 197 school districts for ~500K students.
    + Washington has 296 for ~1M students
+ The three largest school districts, Portland Public, Salem-Keizer, and  Beaverton are about 40K each.
    + Washington has 9 over 20K
+ The remainder are small.

Less opportunity for intra-district funding differences but need to watch the big three.

# Key Points

+ Management and salary levels may be different across districts 
+ There are fewer haves and have nots within and between districts than other states.

We can feel more comfortable using schools out of district for controls given equal funding.

# The Energy Efficiency Measures (EEMs)

Mostly what you would expect

+ Building Envelope, including windows and insulation.
+ HVAC Components  
+ HVAC Controls
+ Pumps, Motors and Drives
+ Domestic Hot Water
+ Lighting
+ Kitchen Equipment
+ Other (Pool Covers ...)

# What Should Strike you About the List

+ Most of the items you would never notice unless you were an expert looking  or listening for them.
+ There are a few that could have an impact on the educational environment.
    + Double or Triple Glazed Windows ( Sound, Moisture Control)
    + Cavity Insulation (Sound, Moisture Control)
    + Lighting Quality Improvements (Daylighting)


# Key Points

+ Treated schools may or may not have educationally impactful EEMs.
+ Treated schools could have a mix.

The non-impactful EEMs can provide a placebo effect robustness check on the effects of the impactful EEMs on educational performance.

# How to Measure Educational Impact

+ Some of the measures produce environmental improvements, less moisture, mold, we can look at the effect on attendance.
    + Recorded annually for each school.
    + Intermediate indicator.  The more often you go to school the better you do.
+ Environmental Improvements can reduce teacher absenteeism.
    + Must be aquired district by district and year by year.
+ Some produce better learning environments, less distraction.  We can use the annual standardized testing results.
    + Everyone in the same grade takes the same test, but the test, and the levels can be different from year-to-year.

# Key Points

+ Test scores are the main indicator but for some EEMs, absenteeism and attendance may be good predictors.
+ We have some candidates for instruments if we wish to take that route.


# Data Details

# Schools Program Audit Requirements

+ Non-educational buildings and those that are rented or will close in 5 years are ineligible.
+ Energy Audits are required
    + Whole Building audits, similar to ASHRAE Level 2.  Identify EEMs with 50 year payback or less.
    + Multi-component payback is allowed
    + Targeted Audits are acceptable for limited scope.
    + Target is 47/48 kBTU/SF/Year for elementary and 61/62 kBTU/SF/Year for High Schools 
+ Multi-competent payback calculations are allowed.

# School Program Implementation

+ The maximum amount of PPC funds reimbursed will be capped at the total annual savings multiplied by the Measure Life caped at cost.
+ Common for some cost to not be funded.
+ Commissioning is required for:
    + All boiler or chiller measures exceeding $100,000
    + All other HVAC measures and all HVAC controls measures exceeding $50,000
    + All lighting control measures exceeding $100,000
    + Other measures in which commissioning is critical for successful implementation and operation of the measure, as deemed appropriate by the auditor.

# Required Annual Reporting

+ Annual energy expenses by fuel type
+ Square footage
+ Hours of operation

# Summary of Measures

```{r InstallByYear, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
EEMs <-read.csv("https://docs.google.com/spreadsheets/d/15X3x4KCEx2-_JYLjq3gXhqS33EKBscW_LLPO-MggDFk/pub?gid=1734037341&single=true&output=csv")

library(dplyr)
library(knitr)

EEMs %>% select(Year  = ImplementedYear) %>% 
  group_by(Year) %>%
   summarize(Installations = n()) %>%
  kable()
```

Note spikes in installation.

# Types of Installed Measures

```{r InstallTypes, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
EEMs %>% select(EEM = MeasureClassDetailDescription) %>%
  group_by(EEM) %>%
  summarize(Installations = n()) %>% 
  kable()

```

# Comments

+ Controls are frequently occupancy sensors and day-lighting controls
+ Fixtures are described in detail later as gym, exterior, etc.

# Electric Utilities

![BPA 2015](https://www.bpa.gov/news/pubs/maps/OregonUtils.pdf)

# Oregon is a mix

+ Most of population is served by IOUs
+ Large tracts of COUs
+ Only Pacificorp and PGE schools are eligible.

# Districts with Eligible Schools

```{r BuildBorderDistricts, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

AllSchools <- read.csv("https://docs.google.com/spreadsheets/d/1WXNu3cNY4DyZ7yWXT2MPd3bd61M0Vmo2ty62Uux1TZU/pub?gid=1048793783&single=true&output=csv")
library(dplyr)
library(stringr)


AllSchools %>% 
  mutate(Charter = str_detect(School.Name, "Charter")) %>%
  mutate(Immersion = str_detect(School.Name, "Immersion")) %>%
  mutate(Magnet = str_detect(School.Name, "Magnet")) -> AllSchools

AllSchools %>% 
  filter (Charter == FALSE & Immersion == FALSE  & Magnet == FALSE) -> AllSchools

AllSchools %>%
  mutate(SpecialPurge = str_detect(Notes, "Housed at") |
           str_detect(Notes, "shared campus") |
           str_detect(Notes, "not own") | 
           str_detect(Notes, "not owned")) -> AllSchools

AllSchools %>% 
  filter (SpecialPurge == FALSE) -> AllSchools

AllSchools %>% 
  group_by(District.ID, District.Name) %>%
  count(SB.1149.Eligibility) %>%
  group_by(District.ID, District.Name) %>%
  count() %>%
  filter(nn >1) -> BorderDistricts
```

```{r MapBoarderDistricts, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}

library(maptools)
Sto <- gpclibPermit()

Schools <- readShapePoly("../MapData/cb_2016_41_unsd_500k/cb_2016_41_unsd_500k.shp")

library(ggmap)

mapImage <- get_map(location = "oregon", zoom = 7, maptype = "toner")


library(RColorBrewer)
colors <- brewer.pal(9, "BuGn")

# Subset SchoolBound so only eligible districts
# 


Split <- function(x) { last(str_split(x, boundary("word"))[[1]])
}

SplitV <- Vectorize(Split)



DistNumbers <- SplitV(as.character(BorderDistricts$District.Name))

# Fix so that only the eligible districts show.
#Schools@data$NAME

SchoolBound <- fortify(Schools)


ggmap(mapImage) 
# +
#   geom_polygon(aes(x = long,
#                    y = lat,
#                    group = group),
#                data = SchoolBound,
#                color = colors[9],
#                fill = colors[6],
#                alpha = 0.5) +
#   labs(x = "Longitude",
#        y = "Latitude")
# 

```

 
# How Many District? Schools?

```{r EligibleSchools, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

AllSchools <- read.csv("https://docs.google.com/spreadsheets/d/1WXNu3cNY4DyZ7yWXT2MPd3bd61M0Vmo2ty62Uux1TZU/pub?gid=1048793783&single=true&output=csv")

AllSchools %>% 
  mutate(Charter = str_detect(School.Name, "Charter")) %>%
  mutate(Immersion = str_detect(School.Name, "Immersion")) %>%
  mutate(Magnet = str_detect(School.Name, "Magnet")) -> AllSchools

AllSchools %>% 
  filter (Charter == FALSE & Immersion == FALSE  & Magnet == FALSE) -> AllSchools

AllSchools %>%
  mutate(SpecialPurge = str_detect(Notes, "Housed at") |
           str_detect(Notes, "shared campus") |
           str_detect(Notes, "not own") | 
           str_detect(Notes, "not owned")) -> AllSchools

AllSchools %>% 
  filter (SpecialPurge == FALSE) -> AllSchools

AllSchools %>% 
  group_by(District.ID, District.Name) %>%
  count(SB.1149.Eligibility) %>%
  group_by(District.ID, District.Name) %>%
  count() %>%
  filter(nn >1) -> BorderDistricts

AllSchools %>%
  inner_join(BorderDistricts) -> BorderSchools

EEMs %>% 
  select(FacilityODEId) %>%
  unique() -> TreatedSchoolIDs

TreatedSchoolIDs$Treated <- TRUE

left_join(BorderSchools, TreatedSchoolIDs, by = c("School.ID" = "FacilityODEId" )) %>%
  mutate(Treated = if_else(Treated == TRUE, TRUE, FALSE, missing=FALSE)) -> BorderSchools
  
BorderSchools %>% 
  filter(Treated == TRUE) %>%
  group_by(District.ID, District.Name) %>%
  count(Treated) %>% 
  filter(n >0) %>%
  select(District.ID,District.Name)-> WithTreated

BorderSchools %>%
  semi_join(WithTreated) -> TreatedDistrictSchools

##
AllSchools %>% 
  filter(SB.1149.Eligibility == "YES") %>%
  select(District.ID) %>%
  unique() %>%
  nrow() -> EligibleDistricts

AllSchools %>% 
  filter(SB.1149.Eligibility == "YES") %>%
  select(School.ID) %>%
  unique() %>%
  nrow() -> EligibleSchools
```

+ Eligible 
    + Districts: `r EligibleDistricts` 
    + Schools: `r EligibleSchools`
+ Border (Eligible and ineligible schools in district)
    + Districts: `r nrow(BorderDistricts)`
    + With treated schools: `r nrow(WithTreated)`
+ Schools in Border Districts : `r nrow(BorderSchools)`
    + Eligible untreated: `r  table(BorderSchools$SB.1149.Eligibility)[2] - table(BorderSchools$Treated)[2]`
    + Eligible treated: `r table(BorderSchools$Treated)[2]`
    + Ineligible: `r table(BorderSchools$SB.1149.Eligibility)[1]`
+ Schools in Border Districts with treated schools : `r nrow(TreatedDistrictSchools)`
    + Eligible untreated: `r  table(TreatedDistrictSchools$SB.1149.Eligibility)[2] - table(TreatedDistrictSchools$Treated)[2]`
    + Eligible treated: `r table(TreatedDistrictSchools$Treated)[2]`
    + Ineligible: `r table(TreatedDistrictSchools$SB.1149.Eligibility)[1]`    
    


# Getting at Causality, the Identification Problem

# Methods

+ Corsened exact matching 
    + Iacus, King, and Porro (2012)
    + Define what you mean by close enough in multiple dimensions
    + Find the close enough match on observable dimensions
    + Excluded treated with no match
+ Synthetic control method 
    + Card, D. and A. Krueger (1994)
    + Mix of differences in differences and matching
    + Weights basket of controls to achieve better results

# Working With Data from ODE

+ Exercise in frustration
    + Separate files per year
    + Little consistency in names, actual data reported, format
    + Non-existent documentation or institutional knowledge
 
```{r LoadFreeReducedData, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

library(readr)

FreeReduced <- read_csv("../FreeReducedLunch/StudentsEligibleforFreeorReducedLunc46.CSV")

library(dplyr)

FreeReduced$Year <- as.numeric(substr(FreeReduced$SCHLYR, nchar(FreeReduced$SCHLYR) - 3, nchar(FreeReduced$SCHLYR)))


FreeReduced %>%
  select( SchoolID  = SCHLINSTID, DistrictID  = DISTINSTID,  FreeLunchPercent = FREEREDLNCHPCT, District = DISTNM, School= SCHLNM, Year  ) -> FreeReduced

```
 
 
```{r LoadAttendanceData, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}
 
# Read the separate files
# 
library(readxl)

Attendance13 <- read_excel("../Attendance/amo-attendance_1213.xls", sheet = "Attendance Data")
Attendance14 <- read_excel("../Attendance/amo-attendance_1314.xlsx", sheet = "Attendance Data")

Attendance15 <- read_excel("../Attendance/attendance_1415.xlsx")
Attendance16 <- read_excel("../Attendance/attendance_1516.xlsx")
Attendance17 <- read_excel("../Attendance/attendance_1617.xlsx")

# Add year to each
Attendance13$Year <- 2013
Attendance14$Year <- 2014
Attendance15$Year <- 2015
Attendance16$Year <- 2016
Attendance17$Year <- 2017

library(dplyr)
bind_rows(Attendance13, Attendance14) %>%
  filter(Subgroup == "All Students", `School/District` == "School") %>%
  select(DistrictID, Distict = `District Name`,  SchoolID = InstID, School = `Institution Name`, Attendance = `Current Attendance Rate`, Year) ->EarlyAttendance

bind_rows(Attendance15, Attendance16, Attendance17)  %>%
  filter(`Student Group` == "All Students") %>%
  select(Distict = `Parent District Name`,  SchoolID = InstID, School = `Institution Name`, Attendance = `Attendance\r\nRate`, Year) ->LateAttendance

# Final Attendance
bind_rows(EarlyAttendance, LateAttendance) %>% unique() -> Attendance

remove(Attendance13, Attendance14, Attendance15, Attendance16, Attendance17, EarlyAttendance, LateAttendance)

```


```{r LoadMembershipData, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}


# Enrollment Reports
# 

library(readxl)

# Read in from local.  Error in http read so resorted to this.

Membership10 <- read_excel("../MembershipReport/fallmembershipreport_20092010.xls", sheet = "School")

Membership11 <- read_excel("../MembershipReport/fallmembershipreport_20102011.xls", sheet = "School (Final)")

Membership12 <- read_excel("../MembershipReport/fallmembershipreport_20112012.xls", sheet = "School (Final)")

Membership13 <- read_excel("../MembershipReport/fallmembershipreport_20122013.xls", sheet = "School (Final)")

Membership14 <- read_excel("../MembershipReport/fallmembershipreport_20132014.xls", sheet = "School (1314)")

Membership15 <- read_excel("../MembershipReport/fallmembershipreport_20142015.xls", sheet = "School (1415)")

Membership16 <- read_excel("../MembershipReport/fallmembershipreport_20152016.xlsx", sheet = "School (15-16)")

Membership17 <- read_excel("../MembershipReport/fallmembershipreport_20162017.xlsx", sheet = "School (16-17)")

#Add year indicator to each dataframe
#
Membership10$Year <- 2010
Membership11$Year <- 2011
Membership12$Year <- 2012
Membership13$Year <- 2013
Membership14$Year <- 2014
Membership15$Year <- 2015
Membership16$Year <- 2016
Membership17$Year <- 2017

# Create common colum names for  data we need
# 

CommonNames1217 <-  c("DistrictID"              
                      ,"District"                                       
                      ,"SchoolID"                
                      ,"School"                                         
                      ,"PrevEnrollment"                       
                      ,"Enrollment"                       
                      ,"Male"                                  
                      ,"PercentMale"                             
                      ,"Female"                                 
                      ,"PercentFemale"                            
                      ,"AmericanIndianAlaskaNative"         
                      ,"PercentAmericanIndianAlaskaNative"    
                      ,"Asian"                                  
                      ,"PercentAsian"                             
                      ,"NativeHawaiianPacificIslander"      
                      ,"PercentNativeHawaiianPacificIslander"
                      ,"AfricanAmerican"                 
                      ,"PercentAfricanAmerican"           
                      ,"Hispanic"                       
                      ,"PercentHispanic"                  
                      ,"White"                                  
                      ,"PercentWhite"                            
                      ,"Multiracial"                            
                      ,"PercentMultiracial"                       
                      ,"Kindergarten"                           
                      ,"GradeOne"                              
                      ,"GradeTwo"                              
                      ,"GradeThree"                            
                      ,"GradeFour"                             
                      ,"GradeFive"                             
                      ,"GradeSix"                              
                      ,"GradeSeven"                            
                      ,"GradeEight"                            
                      ,"GradeNine"                             
                      ,"GradeTen"                              
                      ,"GradeEleven"                           
                      ,"GradeTwelve"                           
                      ,"Year") 



names(Membership12) <- CommonNames1217
names(Membership13) <- CommonNames1217
names(Membership14) <- CommonNames1217
names(Membership15) <- CommonNames1217
names(Membership16) <- CommonNames1217
names(Membership17) <- CommonNames1217

# Only deal with counts not percents
# 
Membership12 %>% select(-contains("Percent")) -> Membership12
Membership13 %>% select(-contains("Percent")) -> Membership13
Membership14 %>% select(-contains("Percent")) -> Membership14
Membership15 %>% select(-contains("Percent")) -> Membership15
Membership16 %>% select(-contains("Percent")) -> Membership16
Membership17 %>% select(-contains("Percent")) -> Membership17

Membership10 %>% select(-contains("%")) -> Membership10
Membership11 %>% select(-contains("%")) -> Membership11



Membership10 %>%
  rename(
    DistrictID = "Attnd\nDistInstID",
    SchoolID = "Attnd\nSchlInstID",  
    Enrollment = "2009-10\nTotal Enrollment",                 
    Male = "2009-10 Male",                                    
    Female ="2009-10\nFemale",                                                      
    AmericanIndianAlaskaNative="2009-10\nAmerican Indian/Alaskan Native\n(Non-Hispanic)",                  
    
    AfricanAmerican= "2009-10\nBlack/African American\n(Non-Hispanic)",
    Hispanic= "2009-10\nHispanic/Latino",                                                 
    White = "2009-10\nWhite\n(Non-Hispanic)",                                           
    Multiracial = "2009-10\nMultiracial\n(Non-Hispanic)",
    
    Kindergarten = "2009-10 Kindergarten",                                                     
    GradeOne = "2009-10 Grade One",                                                        
    GradeTwo = "2009-10 Grade Two",                                                        
    GradeThree = "2009-10 Grade Three",                                                      
    GradeFour = "2009-10 Grade Four",                                                       
    GradeFive = "2009-10 Grade Five",                                                       
    GradeSix = "2009-10 Grade Six",                                                        
    GradeSeven = "2009-10 Grade Seven",                                                      
    GradeEight = "2009-10 Grade Eight",                                                      
    GradeNine = "2009-10 Grade Nine",                                                       
    GradeTen = "2009-10 Grade Ten",                                                        
    GradeEleven = "2009-10 Grade Eleven",                                                     
    GradeTwelve = "2009-10 Grade Twelve",                                                     
    NativeHawaiianPacificIslander = `For Future Reference\n2009-10\nPacific Islander\n(Non-Hispanic)`,
    
    Asian = `For Future Reference\n2009-10\nAsian\n(Non-Hispanic)`
  ) %>%
  select( -contains("2009-10")) -> Membership10

Membership10$PrevEnrollment <- NA

Membership11 %>% 
  rename( DistrictID = "Attending\nDistrict\nInstID",                                                                                       
          SchoolID = "Attending\nSchool\nInstID",                                                     
          PrevEnrollment = "2009-10\nTotal Enrollment",                                                     
          Enrollment = "2010-11\nTotal Enrollment",                                                     
          Male = "2010-11 Male",                                                                  
          Female = "2010-11 Female",                                                                
          AmericanIndianAlaskaNative = "2010-11\nAmerican Indian/Alaskan Native\n(Non-Hispanic)",                       
          
          AfricanAmerican = "2010-11\nBlack/African American\n(Non-Hispanic)",                              
          Hispanic = "2010-11\nHispanic/Latino",                                                      
          White = "2010-11\nWhite\n(Non-Hispanic)",                                                
          Multiracial = "2010-11\nMultiracial\n(Non-Hispanic)",                                          
          Kindergarten = "2010-11\nKindergarten",                                                         
          GradeOne = "2010-11\nGrade One",                                                            
          GradeTwo = "2010-11\nGrade Two",                                                            
          GradeThree = "2010-11\nGrade Three",                                                          
          GradeFour = "2010-11\nGrade Four",                                                           
          GradeFive = "2010-11\nGrade Five",                                                           
          GradeSix = "2010-11\nGrade Six",                                                            
          GradeSeven = "2010-11\nGrade Seven",                                                          
          GradeEight = "2010-11\nGrade Eight",                                                          
          GradeNine = "2010-11\nGrade Nine",                                                           
          GradeTen = "2010-11\nGrade Ten",                                                            
          GradeEleven = "2010-11\nGrade Eleven",                                                         
          GradeTwelve = "2010-11\nGrade Twelve",                                   
          Asian = "For Future Reference\n2010-11\nAsian only\n(Non-Hispanic)", 
          
          NativeHawaiianPacificIslander  = "2010-11\nAsian/Pacific Islander\n(Non-Hispanic)",            
          Year  = "Year" 
  ) %>%   
  select( -contains("2010-11")) -> Membership11

# Enrollment and PrevEnrollment contains notes.  Set those to NA
Membership10$Enrollment <- as.numeric(Membership10$Enrollment)
Membership11$Enrollment <- as.numeric(Membership11$Enrollment)
Membership12$Enrollment <- as.numeric(Membership12$Enrollment)
Membership13$Enrollment <- as.numeric(Membership13$Enrollment)
Membership14$Enrollment <- as.numeric(Membership14$Enrollment)
Membership15$Enrollment <- as.numeric(Membership15$Enrollment)
Membership16$Enrollment <- as.numeric(Membership16$Enrollment)
Membership17$Enrollment <- as.numeric(Membership17$Enrollment)

Membership10$PrevEnrollment <- as.numeric(Membership10$PrevEnrollment)
Membership11$PrevEnrollment <- as.numeric(Membership11$PrevEnrollment)
Membership12$PrevEnrollment <- as.numeric(Membership12$PrevEnrollment)
Membership13$PrevEnrollment <- as.numeric(Membership13$PrevEnrollment)
Membership14$PrevEnrollment <- as.numeric(Membership14$PrevEnrollment)
Membership15$PrevEnrollment <- as.numeric(Membership15$PrevEnrollment)
Membership16$PrevEnrollment <- as.numeric(Membership16$PrevEnrollment)
Membership17$PrevEnrollment <- as.numeric(Membership17$PrevEnrollment)


# Join them
Membership <- bind_rows(Membership10, Membership11, Membership12, Membership13, Membership14, Membership15, Membership16, Membership17) 

# Clean space
remove(Membership10, Membership11, Membership12, Membership13, Membership14, Membership15, Membership16, Membership17, CommonNames1217)

```

```{r LoadTestScores, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

Schools16 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/17/RCmediaSchoolsAggregate.csv")

Schools14 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/15/RCmediaSchoolsAggregate.csv")
# make the school identifiers uniform witth 16 name
# 

Schools13 <- read.csv("http://www.ode.state.or.us/data/reportcard/media/14/RCmediaSchoolsAggregate.csv")

library(dplyr)


###
Schools13 %>% 
  select( DistrictID = District.ID, SchoolID = School.ID,
    Reading.Pct.Met_10 = Reading.Pct.Met.2009.10,
    Math.Pct.Met_10 = Math.Pct.Met.2009.10,  
    Writing.Pct.Met_10 = Writing.Pct.Met.2009.10,  
    Science.Pct.Met_10 = Science.Pct.Met.2009.10,
  ) -> Schools13

Schools14 %>%
  select(DistrictID = District.ID, SchoolID = School.ID,
                        
         Reading.Pct.Met_11 = Reading.Pct.Met.2010.11,               
         Reading.Pct.Met_12 = Reading.Pct.Met.2011.12,               
         Reading.Pct.Met_13 = Reading.Pct.Met.2012.13,
         Reading.Pct.Met_14 = Reading.Pct.Met.2013.14,
         
         Math.Pct.Met_11 = Math.Pct.Met.2010.11,                  
         Math.Pct.Met_12 = Math.Pct.Met.2011.12,                  
         Math.Pct.Met_13 = Math.Pct.Met.2012.13,
         Math.Pct.Met_14 = Math.Pct.Met.2013.14,

         Writing.Pct.Met_11 = Writing.Pct.Met.2010.11,               
         Writing.Pct.Met_12= Writing.Pct.Met.2011.12,               
         Writing.Pct.Met_13 = Writing.Pct.Met.2012.13,        
         Writing.Pct.Met_14 = Writing.Pct.Met.2013.14,
         
                        
         Science.Pct.Met_11 = Science.Pct.Met.2010.11,               
         Science.Pct.Met_12 = Science.Pct.Met.2011.12,               
         Science.Pct.Met_13 = Science.Pct.Met.2012.13,
         Science.Pct.Met_14 = Science.Pct.Met.2013.14
) -> Schools14


Schools16 %>%
  select(DistrictID = District.ID, District = District.Name, SchoolID = School.ID, School = School.Name, Grades.Offered, School.Type,
         ELA.Pct.Met_15 = ELA.Pct.Met.2014.15,                      
         ELA.Pct.Met_16 = ELA.Pct.Met.2015.16, 
         Math.Pct.Met_15 = Math.Pct.Met.2014.15,                     
         Math.Pct.Met_16 = Math.Pct.Met.2015.16,  
         Science.Pct.Met_15= Science.Pct.Met.2014.15,                  
         Science.Pct.Met_16 = Science.Pct.Met.2015.16         
) -> Schools16        

full_join(Schools14, Schools16, by = c("DistrictID", "SchoolID"), suffix = c("", ".KILL")) %>%
  full_join(Schools13, by = c("DistrictID", "SchoolID"), suffix = c("", ".KILL")) %>%
  select(-contains(".KILL")) -> TestScores

remove(Schools14, Schools16, Schools13)

library(dplyr)
library(tidyr)

#Percent pass are top coded at 95% and bottom coded at 5%

TestScores %>% 
  gather(Test, value, contains("met")) %>%
  separate(Test, into = c("Test", "Year"),sep = "_") %>%
  mutate(value = as.numeric(case_when(
    value == ">95"  ~ "95",
    value == "<5" ~ "5",
    value == "*" ~ "NA",
    TRUE ~ value
    ))) %>%
select(DistrictID:School.Type, Year, Test, value)%>% 
  spread(Test, value) %>%
  mutate(Year =  as.numeric(Year) + 2000) -> TestScores
  
```


```{r MergeAll, message=FALSE, warning=FALSE, include=FALSE, paged.print=FALSE}

FreeReduced %>% 
  filter(Year > 2009) %>%
  left_join(TestScores, by = c("DistrictID", "SchoolID", "Year"), suffix = c("",".KILL")) %>%     
  left_join(Attendance, by = c("DistrictID", "SchoolID", "Year"), suffix = c("",".KILL")) %>%
  left_join(Membership, by = c("DistrictID", "SchoolID", "Year"), suffix = c("",".KILL")) %>%
  select(-contains(".KILL")) ->Master


```
# Matching Options

Control group composed of ineligible schools

+ Only within district or not
+ Variables to use with matching
+ Additional variables for matches outside of district



# How Different are Treated, Untreated and Ineligible schools?

Ideally, there should be no _obserable_ difference. As close as you can get to random assignment.

+ Dimensions:
    + Student population, free and reduced rate, ethnicity, etc.
    + Test scores
    + Facility characteristics
+ Problems:
    + Oregon Department of Education discontinued the School Facilities Report in 2002. Only have built and remodel dates before 2001.
    + Material that was in the report is only available for audited buildings in schools.
    + Schools are collections of buildings, not one, very common to have multiple buildings with a variety of vintages. 
    + Elementary near my house has 4 buildings but looks like only 2 .
